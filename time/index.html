<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>北京时间</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="icon" type="image/x-icon" href="favicon.ico">

<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;width:100%;}
body{
    font-family:"Noto Sans SC",sans-serif;
    background:#000;
    color:#ccc;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    text-align:center;
    padding:2vw;
}
.date{font-weight:300;margin-bottom:1vh;font-size:clamp(1.5rem,5vw,4rem);}
.time{font-weight:700;margin-bottom:2vh;font-size:clamp(5rem,15vw,20rem);}
.week{font-weight:400;margin-bottom:3vh;color:#bbb;font-size:clamp(1.2rem,4vw,3rem);}
.footer{position:fixed;bottom:1vh;width:100%;display:flex;justify-content:center;align-items:center;gap:0.5rem;font-size:clamp(0.8rem,3vw,1.5rem);color:#888;}
.dot{width:10px;height:10px;border-radius:50%;background:#666;transition:.3;}
</style>
</head>
<body>
<div class="date" id="date">加载中...</div>
<div class="time" id="time">--:--:--</div>
<div class="week" id="week"></div>
<div class="footer"><div class="dot" id="dot"></div><span id="src">加载中...</span></div>

<script>
const SUNING='/api/time'; // 使用 Vercel serverless 代理
const CACHE_KEY='suning_cache_v1';
const CACHE_MAX_AGE=10*60*1000;

const dEl=document.getElementById('date'),
      tEl=document.getElementById('time'),
      wEl=document.getElementById('week'),
      dot=document.getElementById('dot'),
      srcEl=document.getElementById('src');

let networkOffset=0;

function setDot(on){ dot.style.background = on?'#0f0':'#666'; }
function saveCache(sysTime2){ try{ localStorage.setItem(CACHE_KEY, JSON.stringify({: sysTime2, ts: Date.now()})); }catch{} }
function loadCache(){ try{ const raw=localStorage.getItem(CACHE_KEY); return raw?JSON.parse(raw):null; }catch{return null;} }

async function fetchSuning(retries=3,delay=600){
  for(let i=0;i<retries;i++){
    try{
      const r=await fetch(SUNING,{cache:'no-store'});
      if(!r.ok) throw 0;
      const j=await r.json();
      if(j?.sysTime2) return j.sysTime2;
      // 如果返回错误也尝试下次
    }catch{} 
    if(i<retries-1) await new Promise(r=>setTimeout(r,delay));
  }
  throw new Error('fetch fail');
}

async function initTime(){
  const cache=loadCache();
  if(cache && Date.now()-cache.ts<CACHE_MAX_AGE){
    networkOffset = new Date(cache..replace(/-/g,'/')).getTime() - Date.now();
    setDot(true);
    srcEl.textContent=`时间来源：苏宁（缓存）`;
  } else {
    networkOffset = 0;
    setDot(false);
    srcEl.textContent=`时间来源：本地时间`;
  }
  try{
    const sys=await fetchSuning();
    networkOffset = new Date(sys.replace(/-/g,'/')).getTime() - Date.now();
    setDot(true);
    srcEl.textContent=`时间来源：苏宁（网络）`;
    saveCache(sys);
  }catch{}
}

function tick(){
  const now = Date.now() + networkOffset;
  const displayTime = new Date(now);
  const y=displayTime.getFullYear(), m=displayTime.getMonth()+1, d=displayTime.getDate();
  const hh=displayTime.getHours().toString().padStart(2,'0'),
        mm=displayTime.getMinutes().toString().padStart(2,'0'),
        ss=displayTime.getSeconds().toString().padStart(2,'0');
  const weekday=['星期日','星期一','星期二','星期三','星期四','星期五','星期六'][displayTime.getDay()];
  dEl.textContent=`${y}年${m}月${d}日`;
  tEl.textContent=`${hh}:${mm}:${ss}`;
  wEl.textContent=weekday;
}

async function periodicSync(){
  try{
    const sys=await fetchSuning();
    networkOffset = new Date(sys.replace(/-/g,'/')).getTime() - Date.now();
    setDot(true);
    srcEl.textContent=`时间来源：苏宁（网络）`;
    saveCache(sys);
  }catch{}
}

(async function(){
  tick(); setInterval(tick,1000);
  await initTime();
  setInterval(periodicSync,5*60*1000);
})();
</script>
</body>
</html>
